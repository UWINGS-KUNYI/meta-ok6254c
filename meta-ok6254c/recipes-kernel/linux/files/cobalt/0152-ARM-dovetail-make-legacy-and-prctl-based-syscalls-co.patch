From 217e1f2f447e8d1220ad0b7012311d9c1d4d4c58 Mon Sep 17 00:00:00 2001
From: Philippe Gerum <rpm@xenomai.org>
Date: Thu, 11 Nov 2021 09:36:16 +0100
Subject: [PATCH 152/179] ARM: dovetail: make legacy and prctl-based syscalls
 coexist transparently

Signed-off-by: Philippe Gerum <rpm@xenomai.org>
---
 arch/arm/Kconfig               |  1 +
 arch/arm/kernel/entry-common.S | 25 +++++++++++++++++--------
 2 files changed, 18 insertions(+), 8 deletions(-)

diff --git a/arch/arm/Kconfig b/arch/arm/Kconfig
index 73eb1ee6f..b3454de3c 100644
--- a/arch/arm/Kconfig
+++ b/arch/arm/Kconfig
@@ -238,6 +238,7 @@ config ARCH_MTD_XIP
 # Limited I-pipe compat (syscall routing only).
 config IPIPE_COMPAT
 	bool
+	select DOVETAIL_LEGACY_SYSCALL_RANGE
 
 config ARM_PATCH_PHYS_VIRT
 	bool "Patch physical to virtual translations at runtime" if EMBEDDED
diff --git a/arch/arm/kernel/entry-common.S b/arch/arm/kernel/entry-common.S
index 525500060..62f5810ad 100644
--- a/arch/arm/kernel/entry-common.S
+++ b/arch/arm/kernel/entry-common.S
@@ -294,14 +294,15 @@ local_restart:
 	b	fastcall_try
 1:
 #endif	
-	cmp	scno, #__NR_prctl
-	bne	fastcall_not_prctl
-	ldr	r0, [sp, #S_OLD_R0]
-	tst	r10, #__OOB_SYSCALL_BIT
-	bne	fastcall_try
-fastcall_not_prctl:
+#ifdef CONFIG_DOVETAIL_LEGACY_SYSCALL_RANGE
 	ldr	r0, =#__OOB_SYSCALL_BIT
 	ands	r0, scno, r0
+	bne	fastcall_try
+#endif
+	cmp	scno, #__NR_prctl
+	bne	slow_path
+	ldr	r0, [sp, #S_OLD_R0]
+	tst	r0, #__OOB_SYSCALL_BIT
 	beq	slow_path
 fastcall_try:
 	tst	r10, #_TLF_OOB
@@ -309,6 +310,8 @@ fastcall_try:
 	mov	r0, sp				@ regs
 	bl	handle_oob_syscall
 	ldr	r10, [tsk, #TI_LOCAL_FLAGS]
+	tst	r0, r0
+	beq	slow_path
 	tst	r10, #_TLF_OOB
 	bne	fastcall_exit_check		@ check for MAYDAY
 	bl	sync_inband_irqs
@@ -323,9 +326,15 @@ fastcall_exit_check:
 slow_path:
 	tst	r10, #_TLF_DOVETAIL
 	bne	pipeline_syscall
-	cmp	scno, #__NR_prctl
-	beq	pipeline_syscall
+#ifdef CONFIG_DOVETAIL_LEGACY_SYSCALL_RANGE
+	ldr	r0, =#__OOB_SYSCALL_BIT
 	ands	r0, scno, r0
+	bne	pipeline_syscall
+#endif	
+	cmp	scno, #__NR_prctl
+	bne	root_syscall
+	ldr	r0, [sp, #S_OLD_R0]
+	tst	r0, #__OOB_SYSCALL_BIT
 	beq	root_syscall
 pipeline_syscall:
 	mov	r0, sp				@ regs
-- 
2.38.1

